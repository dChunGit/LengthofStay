{% extends 'base.html' %}

{% block title %}
    View Single Event
{% endblock %}

{% block content %}

    {% if cover_image %}
        <script>
            $(document).ready(function() {
                $.ajaxSetup({cache: false});
                $.get(window.location.origin + "/event?image_id=" + "{{ cover_image }}", function(data, status) {
                    if(status=="success") {
                        console.log(data);
                        $("#image").empty().append("<img class=\"img-thumbnail\" style=\"height: 200px\" src=\"data:;base64," + data + "\">");
                    }
                });
            })
        </script>
    {% endif %}

    {% if event %}
        <div class="container-fluid">
            <div class="d-flex justify-content-between p-0" style="border-bottom: 1px solid; border-color: LightGray;">
                    <h1>{{ event.title }}</h1>
                    <form action="{{ url_for('subscribe_event', event_id=event.id, next_url='view_single_event') }}" method="post">
                        {% if user.check_subscribe_status(event) %}
                            <button type="submit" class="btn btn-primary" name="subscribe_status" value="Unsubscribe">Unsubscribe</button>
                        {% else %}
                            <button type="submit" class="btn btn-primary" name="subscribe_status" value="Subscribe">Subscribe</button>
                        {% endif %}
                    </form>
            </div>
            <div class="d-flex justify-content-between p-0">
                <div>
                    <br>
                    <p>{{ event.description }}</p>
                    <br>
                    <p><span class="font-weight-bold">Time: </span> {{ event.time.strftime('%Y-%m-%d %H:%M') }}</p>
                    <p><span class="font-weight-bold">Location: </span>{{ event.location }}</p>
                    <p><span class="font-weight-bold">Status: </span>{{ event.status }}</p>
                    <br>
                    <p class="font-italic">Created at {{ event.first_updated_time.strftime('%Y-%m-%d %H:%M') }}, updated by {{ event.last_updated_user }} at {{ event.last_updated_time.strftime('%Y-%m-%d %H:%M') }}</p>
                </div>
                <div >
                    {% if cover_image %}
                        <br>
                        <div id="image">
                            <div class="spinner-border" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="container-fluid mt-3 mb-3">
            <div class="btn-toolbar justify-content-end" role="toolbar">
                <div class="btn-group" role="group">
                    <a class="btn btn-primary" href="{{ url_for('add_report', event_id=event.id) }}" role="button">Add Comment</a>
                </div>
            </div>
        </div>
        <div class="list-group">
            {% for report in event.reports[:3] %}
                <a href="{{ url_for('reports', event_id=event.id, report_id=report.id) }}" class="list-group-item list-group-item-action mb-3">
                    <div class="d-flex justify-content-between">
                        <p class="mb-1" style="font-weight: bold">{{ report.username }}:</p>
                        <p class="font-italic">{{ report.time.strftime('%Y-%m-%d %H:%M') }}</p>
                    </div>
                    <p>{{ report.comments }}</p>
                </a>
            {% endfor %}
    {% endif %}

    <div class="container-fluid mt-3 mb-3">
        <div class="d-flex justify-content-between">
            <div class="btn-toolbar" role="toolbar">
                <div class="btn-group" role="group">
                    <a class="btn btn-primary" href="{{ url_for('view_all_events') }}" role="button">Back to Events</a>
                </div>
            </div>
            {% if event.reports|length > 3 %}
                <div class="btn-toolbar" role="toolbar">
                    <div class="btn-group" role="group">
                        <a class="btn btn-primary" href="{{ url_for('reports', event_id=event.id) }}" role="button">More Comments</a>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}
